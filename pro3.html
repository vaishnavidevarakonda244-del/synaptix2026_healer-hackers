from flask import Flask, request, jsonify, render_template_string
import numpy as np
from sklearn.ensemble import IsolationForest

app = Flask(__name__)

# Generate normal training data (simulate healthy vitals)
np.random.seed(42)
normal_data = np.column_stack((
    np.random.normal(75, 10, 200),     # Heart Rate
    np.random.normal(98, 1, 200),      # SpO2
    np.random.normal(36.8, 0.3, 200)   # Temperature
))

model = IsolationForest(contamination=0.1)
model.fit(normal_data)

html_page = """
<!DOCTYPE html>
<html>
<head>
<title>BioSense AI ML Monitor</title>
<style>
body { font-family: Arial; background:#0f172a; color:white; text-align:center; }
.card { background:#1e293b; padding:20px; margin:15px; border-radius:10px; display:inline-block; }
input { padding:8px; margin:5px; border-radius:5px; border:none; }
button { padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:5px; cursor:pointer;}
#result { margin-top:20px; font-size:22px; padding:10px; border-radius:10px;}
.normal { background:green; }
.abnormal { background:red; }
</style>
</head>
<body>

<h1>BioSense AI - ML Continuous Monitor</h1>

<div class="card">
    <input type="number" id="hr" placeholder="Heart Rate">
    <input type="number" id="spo2" placeholder="SpO2">
    <input type="number" step="0.1" id="temp" placeholder="Temperature">
    <br>
    <button onclick="sendData()">Check via ML</button>
</div>

<div id="result">Status: --</div>

<script>
function sendData(){
    let hr = document.getElementById("hr").value;
    let spo2 = document.getElementById("spo2").value;
    let temp = document.getElementById("temp").value;

    fetch("/predict", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({hr:hr, spo2:spo2, temp:temp})
    })
    .then(response => response.json())
    .then(data => {
        let resultBox = document.getElementById("result");
        resultBox.innerHTML = "Status: " + data.status;

        if(data.status == "NORMAL"){
            resultBox.className = "normal";
        } else {
            resultBox.className = "abnormal";
        }
    });
}
</script>

</body>
</html>
"""

@app.route("/")
def home():
    return render_template_string(html_page)

@app.route("/predict", methods=["POST"])
def predict():
    data = request.json
    hr = float(data["hr"])
    spo2 = float(data["spo2"])
    temp = float(data["temp"])

    input_data = np.array([[hr, spo2, temp]])
    prediction = model.predict(input_data)

    if prediction[0] == 1:
        return jsonify({"status": "NORMAL"})
    else:
        return jsonify({"status": "ABNORMAL DETECTED"})

if __name__ == "__main__":
    app.run(debug=True)